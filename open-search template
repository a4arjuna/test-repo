AWSTemplateFormatVersion: '2010-09-09'
Description: 'Deploys a managed Opensearch Service provided by AWS

  '
Parameters:
  OpensearchDomainName:
    Description: Name of the Opensearch service domain
    Type: String
  Subnets:
    Description: Subnets the Opensearch service should be deployed to
    Type: List<AWS::EC2::Subnet::Id>
    #Default: 'subnet-09afb16c256a90946,subnet-0aabc586d4f85e129,subnet-08300338bbd8d2a70'
  SecurityGroups:
    Description: Security group for the Opensearch service
    Type: List<AWS::EC2::SecurityGroup::Id>
   # Default: 'sg-0ebe1c168fcae6467'
  EnvironmentType:
    Description: Environment type of the setup
    Type: String
  PrefixRegion:
    Description: Prefix of the region added to roles
    Type: String
Mappings:
  EnvironmentMap:
    prod:
      InstanceType: m5.large.search
      EsBVolumeSizeInGB: 100
    sb:
      InstanceType: t2.small.search
      EsBVolumeSizeInGB: 10
Resources:
  OpensearchDomain:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::OpenSearchService::Domain
    Properties:
      DomainName:
        Ref: OpensearchDomainName
      EngineVersion: 'OpenSearch_1.1'
      ClusterConfig:
        ZoneAwarenessEnabled: true
        ZoneAwarenessConfig:
          AvailabilityZoneCount: 3
        DedicatedMasterEnabled: false
        InstanceCount: 3
        InstanceType:
          Fn::FindInMap:
          - EnvironmentMap
          - Ref: EnvironmentType
          - InstanceType
      NodeToNodeEncryptionOptions:
        Enabled: true
      EncryptionAtRestOptions:
        Enabled: true
      EBSOptions:
        EBSEnabled: true
        Iops: 0
        VolumeSize:
          Fn::FindInMap:
          - EnvironmentMap
          - Ref: EnvironmentType
          - EsBVolumeSizeInGB
        VolumeType: gp2
      SnapshotOptions:
        AutomatedSnapshotStartHour: 3
      VPCOptions:
        SubnetIds:
          Ref: Subnets
        SecurityGroupIds:
          Ref: SecurityGroups
      AdvancedOptions:
        rest.action.multi.allow_explicit_index: 'true'
Outputs:
  OpensearchDomain:
    Description: Reference to the Opensearch Domain
    Value:
      !Ref OpensearchDomain
  DomainEndpoint:
    Description: Reference to the Opensearch Domain
    Value:
      Fn::GetAtt:
      - OpensearchDomain
      - DomainEndpoint
